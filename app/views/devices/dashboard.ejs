<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Smart Bottle</title>
  <link rel="stylesheet" href="/assets/css/dashboard.css">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    .dashboard-container { max-width: 1400px; margin: 0 auto; padding: var(--spacing-8); }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-8); }
    .dashboard-title { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary); }
    .back-btn { background: var(--color-gray-100); color: var(--color-text-secondary); padding: var(--spacing-3) var(--spacing-6); border-radius: var(--radius-md); border: none; font-weight: var(--font-weight-medium); cursor: pointer; transition: all var(--transition-base); text-decoration: none; }
    .back-btn:hover { background: var(--color-gray-200); }

    /* ìˆ˜ìœ  ìƒíƒœ ì¹´ë“œ */
    .feeding-status-card { background: var(--color-white); border-radius: var(--radius-2xl); padding: var(--spacing-8); box-shadow: var(--shadow-md); margin-bottom: var(--spacing-6); }
    .status-header { text-align: center; margin-bottom: var(--spacing-6); }
    .status-icon { font-size: 80px; margin-bottom: var(--spacing-4); }
    .status-title { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary); margin-bottom: var(--spacing-2); }
    .status-desc { font-size: var(--font-size-lg); color: var(--color-text-secondary); }

    /* ìƒíƒœë³„ ìƒ‰ìƒ */
    .status-idle { color: var(--color-text-tertiary); }
    .status-ready { color: var(--color-warning); animation: pulse 2s ease-in-out infinite; }
    .status-feeding { color: var(--color-primary); animation: pulse 1.5s ease-in-out infinite; }
    .status-completed { color: var(--color-success); }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    /* ì¸¡ì • ë°ì´í„° ê·¸ë¦¬ë“œ */
    .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-4); margin-top: var(--spacing-6); }
    .data-item { background: var(--color-gray-50); padding: var(--spacing-4); border-radius: var(--radius-lg); text-align: center; }
    .data-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-2); }
    .data-value { font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary); }
    .data-unit { font-size: var(--font-size-base); color: var(--color-text-tertiary); margin-left: var(--spacing-1); }

    /* ì˜¨ë„ ì•ˆì „ í‘œì‹œ */
    .temp-safe { color: var(--color-success); }
    .temp-unsafe { color: var(--color-error); animation: blink 1s ease-in-out infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* ì—°ê²° ìƒíƒœ */
    .connection-status { display: inline-flex; align-items: center; gap: var(--spacing-2); padding: var(--spacing-2) var(--spacing-4); border-radius: var(--radius-full); font-size: var(--font-size-sm); }
    .connection-online { background: var(--color-success-lighter); color: var(--color-success); }
    .connection-offline { background: var(--color-gray-100); color: var(--color-text-tertiary); }
    .connection-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse-dot 2s ease-in-out infinite; }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }

    /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
    .progress-container { background: var(--color-gray-100); border-radius: var(--radius-full); height: 8px; margin-top: var(--spacing-4); overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light)); transition: width 0.5s ease; }

    /* ì‹¤ì‹œê°„ ë¡œê·¸ */
    .log-container { background: var(--color-white); border-radius: var(--radius-2xl); padding: var(--spacing-6); box-shadow: var(--shadow-sm); max-height: 400px; overflow-y: auto; }
    .log-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--spacing-4); }
    .log-item { padding: var(--spacing-3); border-left: 3px solid var(--color-primary-lighter); background: var(--color-gray-50); margin-bottom: var(--spacing-2); border-radius: var(--radius-md); font-size: var(--font-size-sm); }
    .log-time { color: var(--color-text-tertiary); font-size: var(--font-size-xs); }
    .log-message { color: var(--color-text-primary); margin-top: var(--spacing-1); }

    /* ìˆ˜ìœ  ê¸°ë¡ í…Œì´ë¸” */
    .feeding-records-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-sm); }
    .feeding-records-table thead tr { background: var(--color-gray-50); }
    .feeding-records-table th { padding: var(--spacing-3); border-bottom: 2px solid var(--color-gray-200); text-align: left; font-weight: var(--font-weight-semibold); color: var(--color-text-secondary); }
    .feeding-records-table tbody tr { border-bottom: 1px solid var(--color-gray-100); transition: background var(--transition-base); }
    .feeding-records-table tbody tr:hover { background: var(--color-gray-50); }
    .feeding-records-table td { padding: var(--spacing-3); }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- í—¤ë” -->
    <div class="dashboard-header">
      <div>
        <h1 class="dashboard-title">ğŸ¼ <%= device.device_name %></h1>
        <div style="margin-top: var(--spacing-2);">
          <span class="connection-status connection-offline" id="connectionStatus">
            <span class="connection-dot"></span>
            ì—°ê²° ëŒ€ê¸° ì¤‘
          </span>
        </div>
      </div>
      <a href="/devices" class="back-btn">â† ê¸°ê¸° ëª©ë¡</a>
    </div>

    <!-- ìˆ˜ìœ  ìƒíƒœ ì¹´ë“œ -->
    <div class="feeding-status-card">
      <div class="status-header">
        <div class="status-icon" id="statusIcon">ğŸ’¤</div>
        <h2 class="status-title" id="statusTitle">ëŒ€ê¸° ì¤‘</h2>
        <p class="status-desc" id="statusDesc">ì –ë³‘ì„ ë¬´ê²Œ ì„¼ì„œì— ì˜¬ë ¤ì£¼ì„¸ìš”</p>
      </div>

      <!-- ì¸¡ì • ë°ì´í„° -->
      <div class="data-grid">
        <div class="data-item">
          <div class="data-label">ì´ˆê¸° ë¶„ìœ ëŸ‰</div>
          <div class="data-value">
            <span id="beforeWeight">-</span>
            <span class="data-unit">g</span>
          </div>
        </div>
        <div class="data-item">
          <div class="data-label">ë§ˆì§€ë§‰ ë¶„ìœ ëŸ‰</div>
          <div class="data-value">
            <span id="afterWeight">-</span>
            <span class="data-unit">g</span>
          </div>
        </div>
        <div class="data-item">
          <div class="data-label">ì´ ë§ˆì‹  ì–‘</div>
          <div class="data-value">
            <span id="consumedAmount" style="color: var(--color-primary);">-</span>
            <span class="data-unit">ml</span>
          </div>
          <div style="margin-top: var(--spacing-1); font-size: var(--font-size-xs); color: var(--color-text-tertiary);">
            <span id="consumedCalc">-</span>
          </div>
        </div>
        <div class="data-item">
          <div class="data-label">ì˜¨ë„</div>
          <div class="data-value">
            <span id="temperature">-</span>
            <span class="data-unit">Â°C</span>
          </div>
        </div>
        <div class="data-item">
          <div class="data-label">ì†Œìš” ì‹œê°„</div>
          <div class="data-value">
            <span id="duration">-</span>
            <span class="data-unit">ì´ˆ</span>
          </div>
        </div>
        <div class="data-item">
          <div class="data-label">ì„¸ì…˜ ID</div>
          <div class="data-value" style="font-size: var(--font-size-lg);">
            <span id="sessionId">-</span>
          </div>
        </div>
      </div>

      <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” (ìˆ˜ìœ  ì¤‘ì—ë§Œ í‘œì‹œ) -->
      <div id="progressContainer" style="display: none;">
        <div class="progress-container">
          <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
        </div>
        <p style="text-align: center; margin-top: var(--spacing-2); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
          ìˆ˜ìœ  ì§„í–‰ ì¤‘...
        </p>
      </div>
    </div>

    <!-- ìˆ˜ìœ  ê¸°ë¡ í…Œì´ë¸” -->
    <div class="log-container" style="margin-bottom: var(--spacing-6);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4);">
        <h3 class="log-title">ğŸ“Š ìˆ˜ìœ  ê¸°ë¡</h3>
        <button onclick="loadFeedingRecords()" style="background: var(--color-primary); color: var(--color-white); padding: var(--spacing-2) var(--spacing-4); border-radius: var(--radius-md); border: none; cursor: pointer; font-size: var(--font-size-sm);">
          ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
      </div>
      <div id="feedingRecords" style="overflow-x: auto;">
        <p style="text-align: center; color: var(--color-text-tertiary); padding: var(--spacing-4);">
          ìˆ˜ìœ  ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </p>
      </div>
    </div>

    <!-- ì‹¤ì‹œê°„ ë¡œê·¸ -->
    <div class="log-container">
      <h3 class="log-title">ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
      <div id="logList">
        <div class="log-item">
          <div class="log-time">ì‹œìŠ¤í…œ ì‹œì‘</div>
          <div class="log-message">ëŒ€ì‹œë³´ë“œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const deviceId = <%= device.device_id %>;
    const deviceUuid = '<%= device.device_uuid %>';
    const bottleWeight = <%= device.bottle_weight || 0 %>;

    let socket = null;
    let currentSessionId = null;
    let currentState = 'idle';  // í˜„ì¬ ìˆ˜ìœ  ìƒíƒœ: idle, ready, feeding, completed
    let feedingStartTime = null;
    let durationInterval = null;

    // Socket.IO ì—°ê²°
    function connectSocket() {
      socket = io();

      socket.on('connect', () => {
        console.log('âœ… Socket.IO ì—°ê²°ë¨');
        updateConnectionStatus(true);
        addLog('ì„œë²„ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
      });

      socket.on('disconnect', () => {
        console.log('âŒ Socket.IO ì—°ê²° ëŠê¹€');
        updateConnectionStatus(false);
        addLog('ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
      });

      // ê¸°ê¸° ì˜¨ë¼ì¸ ìƒíƒœ
      socket.on('device:online', (data) => {
        if (data.device_uuid === deviceUuid) {
          addLog(`ê¸°ê¸°ê°€ ì˜¨ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤: ${data.device_name}`);
        }
      });

      // ê¸°ê¸° ì˜¤í”„ë¼ì¸ ìƒíƒœ
      socket.on('device:offline', (data) => {
        if (data.device_uuid === deviceUuid) {
          addLog('ê¸°ê¸°ê°€ ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.');
          resetStatus();
        }
      });

      // ìˆ˜ìœ  ì‹œì‘ (ì¤€ë¹„ ì¤‘)
      socket.on('feeding:started', (data) => {
        if (data.device_uuid === deviceUuid) {
          currentSessionId = data.session_id;
          currentState = 'ready';
          updateStatus('ready', 'ğŸŸ¡ ì¤€ë¹„ ì¤‘', 'ì –ë³‘ì„ ì˜¬ë ¤ì£¼ì„¸ìš”');
          document.getElementById('sessionId').textContent = data.session_id;
          addLog(`ìˆ˜ìœ  ì„¸ì…˜ ì‹œì‘: ID ${data.session_id}`);
        }
      });

      // ì –ë³‘ ì˜¬ë¦¼ (ì˜¨ë„ ì¸¡ì • ì™„ë£Œ)
      socket.on('bottle:status', (data) => {
        if (data.session_id === currentSessionId) {
          const tempSafe = data.temperature_safe;
          const tempStatus = data.temperature_status || 'safe';
          const initialWeight = data.weight_actual || (data.weight - bottleWeight);

          currentState = 'ready';  // ìƒíƒœ ì„¤ì •

          document.getElementById('beforeWeight').textContent = initialWeight.toFixed(1);
          document.getElementById('temperature').textContent = data.temperature.toFixed(1);
          document.getElementById('temperature').className = tempSafe ? 'temp-safe' : 'temp-unsafe';

          // ì˜¨ë„ ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€
          let tempMessage;
          if (tempSafe) {
            tempMessage = `${data.temperature.toFixed(1)}Â°C - ì ì • ì˜¨ë„ì…ë‹ˆë‹¤`;
          } else if (tempStatus === 'low') {
            tempMessage = `${data.temperature.toFixed(1)}Â°C - ì˜¨ë„ê°€ ë‚®ìŠµë‹ˆë‹¤`;
          } else {
            tempMessage = `${data.temperature.toFixed(1)}Â°C - ì˜¨ë„ê°€ ë†’ìŠµë‹ˆë‹¤`;
          }

          updateStatus(
            'ready',
            tempSafe ? 'âœ… ì˜¨ë„ ì ì •' : 'âš ï¸ ì˜¨ë„ ì£¼ì˜',
            tempMessage
          );

          addLog(`ì –ë³‘ ê°ì§€: ì´ˆê¸° ë¶„ìœ ëŸ‰ ${initialWeight.toFixed(1)}g, ì˜¨ë„ ${data.temperature.toFixed(1)}Â°C ${tempSafe ? '(ì•ˆì „)' : tempStatus === 'low' ? '(ë‚®ìŒ)' : '(ë†’ìŒ)'}`);
        }
      });

      // ì˜¨ë„ ì—…ë°ì´íŠ¸ (ì§€ì† ì¸¡ì •)
      socket.on('temperature:status', (data) => {
        // ì˜¨ë„ëŠ” ì„¸ì…˜ê³¼ ê´€ê³„ì—†ì´ í•­ìƒ ì—…ë°ì´íŠ¸
        const tempSafe = data.temperature_safe;
        const tempStatus = data.temperature_status || 'safe';

        // ì˜¨ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
        const tempElement = document.getElementById('temperature');
        tempElement.textContent = data.temperature.toFixed(1);
        tempElement.className = tempSafe ? 'temp-safe' : 'temp-unsafe';

        // ì˜¨ë„ ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€
        let tempMessage;
        if (tempSafe) {
          tempMessage = `${data.temperature.toFixed(1)}Â°C - ì ì • ì˜¨ë„ì…ë‹ˆë‹¤`;
        } else if (tempStatus === 'low') {
          tempMessage = `${data.temperature.toFixed(1)}Â°C - ì˜¨ë„ê°€ ë‚®ìŠµë‹ˆë‹¤`;
        } else {
          tempMessage = `${data.temperature.toFixed(1)}Â°C - ì˜¨ë„ê°€ ë†’ìŠµë‹ˆë‹¤`;
        }

        // í˜„ì¬ ì„¸ì…˜ì˜ ì˜¨ë„ ì—…ë°ì´íŠ¸ì¸ ê²½ìš° ì¶”ê°€ ì²˜ë¦¬
        if (data.session_id === currentSessionId) {
          // ìƒíƒœ ì„¤ëª… í•­ìƒ ì—…ë°ì´íŠ¸ (ì¤€ë¹„ ì¤‘ì´ê±°ë‚˜ ìˆ˜ìœ  ëŒ€ê¸° ì¤‘ì¼ ë•Œ)
          if (currentState === 'ready') {
            updateStatus(
              'ready',
              tempSafe ? 'âœ… ì˜¨ë„ ì ì •' : 'âš ï¸ ì˜¨ë„ ì£¼ì˜',
              tempMessage
            );
          }

          addLog(`ì˜¨ë„ ì—…ë°ì´íŠ¸: ${data.temperature.toFixed(1)}Â°C ${tempSafe ? '(ì•ˆì „)' : tempStatus === 'low' ? '(ë‚®ìŒ)' : '(ë†’ìŒ)'}`);
        } else {
          // ì„¸ì…˜ì´ ì—†ì–´ë„ ì˜¨ë„ëŠ” í‘œì‹œ (ë¡œê·¸ë§Œ ê°„ë‹¨í•˜ê²Œ)
          console.log(`ì˜¨ë„ ì¸¡ì •: ${data.temperature.toFixed(1)}Â°C ${tempSafe ? '(ì•ˆì „)' : tempStatus === 'low' ? '(ë‚®ìŒ)' : '(ë†’ìŒ)'}`);
        }
      });

      // ìˆ˜ìœ  ì§„í–‰ ì¤‘
      socket.on('feeding:in_progress', (data) => {
        if (data.session_id === currentSessionId) {
          currentState = 'feeding';
          updateStatus('feeding', 'ğŸ¼ ìˆ˜ìœ  ì¤‘', 'ì•„ê¸°ê°€ ë¶„ìœ ë¥¼ ë¨¹ê³  ìˆìŠµë‹ˆë‹¤');
          feedingStartTime = new Date();
          startDurationTimer();
          showProgress();
          addLog('ìˆ˜ìœ  ì‹œì‘: ì•„ê¸°ê°€ ì –ë³‘ì„ ë“¤ì—ˆìŠµë‹ˆë‹¤.');
        }
      });

      // ìˆ˜ìœ  ì™„ë£Œ
      socket.on('feeding:completed', (data) => {
        if (data.session_id === currentSessionId) {
          currentState = 'completed';
          stopDurationTimer();
          hideProgress();

          const beforeWeight = data.weight_before || 0;
          const afterWeight = data.weight_after || 0;
          const consumed = data.amount_consumed || 0;
          const durationSeconds = data.duration || 0;

          document.getElementById('afterWeight').textContent = afterWeight.toFixed(1);
          document.getElementById('consumedAmount').textContent = consumed.toFixed(1);
          document.getElementById('consumedCalc').textContent = `(${beforeWeight.toFixed(1)}g - ${afterWeight.toFixed(1)}g)`;
          document.getElementById('duration').textContent = durationSeconds;

          updateStatus('completed', 'âœ… ìˆ˜ìœ  ì™„ë£Œ', `${consumed.toFixed(1)}mlë¥¼ ë§ˆì…¨ìŠµë‹ˆë‹¤`);
          addLog(`ìˆ˜ìœ  ì™„ë£Œ: ${consumed.toFixed(1)}ml (${beforeWeight.toFixed(1)}g â†’ ${afterWeight.toFixed(1)}g), ${durationSeconds}ì´ˆ ì†Œìš”`);

          // ìˆ˜ìœ  ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
          loadFeedingRecords();

          // 5ì´ˆ í›„ ì´ˆê¸°í™”
          setTimeout(() => {
            resetStatus();
            addLog('ìƒˆë¡œìš´ ìˆ˜ìœ ë¥¼ ëŒ€ê¸°í•©ë‹ˆë‹¤.');
          }, 5000);
        }
      });

      // ì—ëŸ¬
      socket.on('error', (data) => {
        addLog(`âš ï¸ ì—ëŸ¬: ${data.message}`, true);
      });
    }

    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateConnectionStatus(isOnline) {
      const statusEl = document.getElementById('connectionStatus');
      if (isOnline) {
        statusEl.className = 'connection-status connection-online';
        statusEl.innerHTML = '<span class="connection-dot"></span> ì—°ê²°ë¨';
      } else {
        statusEl.className = 'connection-status connection-offline';
        statusEl.innerHTML = '<span class="connection-dot"></span> ì—°ê²° ëŠê¹€';
      }
    }

    // ìˆ˜ìœ  ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(state, title, desc) {
      const icons = {
        idle: 'ğŸ’¤',
        ready: 'ğŸŸ¡',
        feeding: 'ğŸ¼',
        completed: 'âœ…'
      };

      document.getElementById('statusIcon').textContent = icons[state] || 'ğŸ’¤';
      document.getElementById('statusIcon').className = 'status-icon status-' + state;
      document.getElementById('statusTitle').textContent = title;
      document.getElementById('statusDesc').textContent = desc;
    }

    // ìƒíƒœ ì´ˆê¸°í™”
    function resetStatus() {
      currentSessionId = null;
      currentState = 'idle';
      feedingStartTime = null;
      stopDurationTimer();
      hideProgress();

      updateStatus('idle', 'ëŒ€ê¸° ì¤‘', 'ì –ë³‘ì„ ë¬´ê²Œ ì„¼ì„œì— ì˜¬ë ¤ì£¼ì„¸ìš”');
      document.getElementById('sessionId').textContent = '-';
      document.getElementById('beforeWeight').textContent = '-';
      document.getElementById('afterWeight').textContent = '-';
      document.getElementById('consumedAmount').textContent = '-';
      document.getElementById('consumedCalc').textContent = '-';
      document.getElementById('temperature').textContent = '-';
      document.getElementById('duration').textContent = '-';
    }

    // ì†Œìš” ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘ (ì´ˆ ë‹¨ìœ„)
    function startDurationTimer() {
      durationInterval = setInterval(() => {
        if (feedingStartTime) {
          const elapsed = Math.floor((new Date() - feedingStartTime) / 1000);
          document.getElementById('duration').textContent = elapsed;
        }
      }, 1000);
    }

    // ì†Œìš” ì‹œê°„ íƒ€ì´ë¨¸ ì¤‘ì§€
    function stopDurationTimer() {
      if (durationInterval) {
        clearInterval(durationInterval);
        durationInterval = null;
      }
    }

    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” í‘œì‹œ
    function showProgress() {
      document.getElementById('progressContainer').style.display = 'block';
      animateProgress();
    }

    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ìˆ¨ê¹€
    function hideProgress() {
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
    }

    // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜
    function animateProgress() {
      let progress = 0;
      const interval = setInterval(() => {
        progress += 1;
        if (progress > 100) progress = 0;
        document.getElementById('progressBar').style.width = progress + '%';
      }, 100);
    }

    // ë¡œê·¸ ì¶”ê°€
    function addLog(message, isError = false) {
      const logList = document.getElementById('logList');
      const logItem = document.createElement('div');
      logItem.className = 'log-item';
      if (isError) logItem.style.borderLeftColor = 'var(--color-error)';

      const time = new Date().toLocaleTimeString('ko-KR');
      logItem.innerHTML = `
        <div class="log-time">${time}</div>
        <div class="log-message">${message}</div>
      `;

      logList.insertBefore(logItem, logList.firstChild);

      // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ ìœ ì§€
      while (logList.children.length > 50) {
        logList.removeChild(logList.lastChild);
      }
    }

    // ìˆ˜ìœ  ê¸°ë¡ ë¡œë“œ
    async function loadFeedingRecords() {
      try {
        const response = await fetch(`/devices/api/${deviceId}/feedings?limit=20`);
        const result = await response.json();

        console.log('ìˆ˜ìœ  ê¸°ë¡ ë°ì´í„°:', result);

        const container = document.getElementById('feedingRecords');

        if (!result.success || result.data.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--color-text-tertiary); padding: var(--spacing-4);">ì•„ì§ ìˆ˜ìœ  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        console.log('ì²« ë²ˆì§¸ ê¸°ë¡ ìƒ˜í”Œ:', result.data[0]);

        // í…Œì´ë¸” ìƒì„±
        let tableHtml = `
          <table class="feeding-records-table">
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>ì´ˆê¸° ë¶„ìœ ëŸ‰</th>
                <th>ë§ˆì§€ë§‰ ë¶„ìœ ëŸ‰</th>
                <th>ë§ˆì‹  ì–‘</th>
                <th>ì˜¨ë„</th>
                <th>ì†Œìš” ì‹œê°„</th>
                <th>ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody>
        `;

        result.data.forEach((record, index) => {
          try {
            const time = new Date(record.timestamp).toLocaleString('ko-KR', {
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            // ìˆ«ì ë³€í™˜ (DBì—ì„œ ë¬¸ìì—´ë¡œ ì˜¬ ìˆ˜ ìˆìŒ)
            let amount = '-';
            if (record.amount_consumed !== null && record.amount_consumed !== undefined) {
              const amountNum = parseFloat(record.amount_consumed);
              amount = !isNaN(amountNum) ? amountNum.toFixed(1) : '-';
            }

            let temp = '-';
            if (record.temperature !== null && record.temperature !== undefined) {
              const tempNum = parseFloat(record.temperature);
              temp = !isNaN(tempNum) ? tempNum.toFixed(1) : '-';
            }

            const tempSafe = record.temperature_safe === 1 || record.temperature_safe === true;

            let duration = '-';
            if (record.duration !== null && record.duration !== undefined) {
              const durationNum = parseFloat(record.duration);
              duration = !isNaN(durationNum) ? durationNum : '-';
            }

            const tempColor = tempSafe ? 'var(--color-success)' : 'var(--color-error)';
            const tempIcon = tempSafe ? 'âœ“' : 'âš ';

            // ì´ˆê¸°/ë§ˆì§€ë§‰ ë¶„ìœ ëŸ‰ ê³„ì‚° (feeding_sessions í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜´)
            let beforeWeight = '-';
            let afterWeight = '-';

            // weight_beforeëŠ” feeding_recordsì— ì—†ìœ¼ë¯€ë¡œ, amount_consumedì™€ weightë¥¼ í™œìš©
            // amount_consumed = weight_before - weight_after
            // ë‹¨ìˆœíˆ í‘œì‹œë§Œ í•˜ì (ë°ì´í„°ê°€ ì—†ìœ¼ë©´ - í‘œì‹œ)
            if (record.weight_before !== null && record.weight_before !== undefined) {
              const beforeNum = parseFloat(record.weight_before);
              beforeWeight = !isNaN(beforeNum) ? beforeNum.toFixed(1) : '-';
            }

            if (record.weight_after !== null && record.weight_after !== undefined) {
              const afterNum = parseFloat(record.weight_after);
              afterWeight = !isNaN(afterNum) ? afterNum.toFixed(1) : '-';
            }

            // weight_beforeê°€ ì—†ìœ¼ë©´ amount_consumed + weight_afterë¡œ ê³„ì‚°
            if (beforeWeight === '-' && amount !== '-' && afterWeight !== '-') {
              const calculated = parseFloat(amount) + parseFloat(afterWeight);
              beforeWeight = !isNaN(calculated) ? calculated.toFixed(1) : '-';
            }

            tableHtml += `
              <tr>
                <td>${time}</td>
                <td>${beforeWeight}g</td>
                <td>${afterWeight}g</td>
                <td style="font-weight: var(--font-weight-semibold); color: var(--color-primary);">${amount} ml</td>
                <td style="color: ${tempColor};">${tempIcon} ${temp}Â°C</td>
                <td>${duration}ì´ˆ</td>
                <td><span style="background: var(--color-success-lighter); color: var(--color-success); padding: 2px 8px; border-radius: var(--radius-full); font-size: var(--font-size-xs);">ì™„ë£Œ</span></td>
              </tr>
            `;
          } catch (error) {
            console.error(`ë ˆì½”ë“œ ${index} ì²˜ë¦¬ ì˜¤ë¥˜:`, error, record);
          }
        });

        tableHtml += `
            </tbody>
          </table>
        `;

        container.innerHTML = tableHtml;
        addLog(`ìˆ˜ìœ  ê¸°ë¡ ${result.data.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      } catch (error) {
        console.error('ìˆ˜ìœ  ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('feedingRecords').innerHTML =
          '<p style="text-align: center; color: var(--color-error); padding: var(--spacing-4);">ìˆ˜ìœ  ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        addLog('âš ï¸ ìˆ˜ìœ  ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨', true);
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ Socket.IO ì—°ê²° ë° ìˆ˜ìœ  ê¸°ë¡ ë¡œë“œ
    window.addEventListener('DOMContentLoaded', () => {
      connectSocket();
      loadFeedingRecords();
      addLog(`ê¸°ê¸° ëŒ€ì‹œë³´ë“œ ì‹œì‘: ${deviceUuid}`);
      if (bottleWeight === 0) {
        addLog('âš ï¸ ë¶„ìœ í†µ ë¬´ê²Œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •í™•í•œ ì¸¡ì •ì„ ìœ„í•´ ë“±ë¡í•˜ì„¸ìš”.', true);
      }
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
    window.addEventListener('beforeunload', () => {
      if (socket) {
        socket.disconnect();
      }
    });
  </script>
</body>
</html>
