<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Smart Bottle</title>
  <link rel="stylesheet" href="/assets/css/dashboard.css">
  <style>
    :root {
      --color-error-lighter: #FEE2E2;
    }
    .devices-container { max-width: 1200px; margin: 0 auto; padding: var(--spacing-8); }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-8); }
    .page-title { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary); }
    .btn-primary { background: var(--color-primary); color: var(--color-text-inverse); padding: var(--spacing-3) var(--spacing-6); border-radius: var(--radius-md); border: none; font-weight: var(--font-weight-medium); cursor: pointer; transition: all var(--transition-base); }
    .btn-primary:hover { background: var(--color-primary-dark); }
    .devices-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: var(--spacing-6); }
    .device-card { background: var(--color-white); border-radius: var(--radius-2xl); padding: var(--spacing-6); box-shadow: var(--shadow-sm); transition: all var(--transition-base); }
    .device-card:hover { box-shadow: var(--shadow-md); }
    .device-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-4); }
    .device-name { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); color: var(--color-text-primary); margin-bottom: var(--spacing-2); }
    .device-uuid { font-size: var(--font-size-sm); color: var(--color-text-tertiary); font-family: monospace; }
    .status-badge { padding: var(--spacing-1) var(--spacing-3); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium); }
    .status-online { background: var(--color-success-lighter); color: var(--color-success); }
    .status-offline { background: var(--color-gray-100); color: var(--color-text-tertiary); }
    .device-info { margin-bottom: var(--spacing-4); }
    .info-row { display: flex; justify-content: space-between; padding: var(--spacing-2) 0; border-bottom: 1px solid var(--color-gray-100); }
    .info-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
    .info-value { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-primary); }
    .device-actions { display: flex; gap: var(--spacing-2); }
    .btn-edit, .btn-delete { flex: 1; padding: var(--spacing-2) var(--spacing-4); border-radius: var(--radius-md); border: none; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); cursor: pointer; transition: all var(--transition-base); }
    .btn-edit { background: var(--color-primary-lighter); color: var(--color-primary); }
    .btn-edit:hover { background: var(--color-primary-light); color: var(--color-white); }
    .btn-delete { background: var(--color-gray-100); color: var(--color-text-secondary); }
    .btn-delete:hover { background: var(--color-error); color: var(--color-white); }
    .empty-state { text-align: center; padding: var(--spacing-16); }
    .empty-icon { font-size: 64px; margin-bottom: var(--spacing-4); }
    .empty-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); color: var(--color-text-primary); margin-bottom: var(--spacing-2); }
    .empty-desc { font-size: var(--font-size-base); color: var(--color-text-secondary); margin-bottom: var(--spacing-6); }

    /* ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ */
    .status-badge { transition: all 0.3s ease; }
    .status-changed { animation: statusPulse 0.5s ease; }
    @keyframes statusPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .update-indicator { position: fixed; top: var(--spacing-4); right: var(--spacing-4); background: var(--color-white); padding: var(--spacing-2) var(--spacing-4); border-radius: var(--radius-full); box-shadow: var(--shadow-md); font-size: var(--font-size-sm); color: var(--color-text-secondary); display: none; align-items: center; gap: var(--spacing-2); }
    .update-indicator.active { display: flex; }
    .update-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--color-success); animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body>
  <!-- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¸ë””ì¼€ì´í„° -->
  <div id="updateIndicator" class="update-indicator">
    <div class="update-dot"></div>
    ì‹¤ì‹œê°„ ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘
  </div>

  <div class="devices-container">
    <div class="page-header">
      <h1 class="page-title">ğŸ”Œ ê¸°ê¸° ê´€ë¦¬</h1>
      <a href="/devices/register" class="btn-primary">+ ìƒˆ ê¸°ê¸° ë“±ë¡</a>
    </div>

    <% if (devices && devices.length > 0) { %>
      <div class="devices-grid" id="devicesGrid">
        <% devices.forEach(device => { %>
          <div class="device-card" data-device-id="<%= device.device_id %>">
            <div class="device-header">
              <div>
                <div class="device-name"><%= device.device_name %></div>
                <div class="device-uuid"><%= device.device_uuid %></div>
              </div>
              <span class="status-badge <%= device.is_online ? 'status-online' : 'status-offline' %>" data-status="<%= device.is_online ? 'online' : 'offline' %>">
                <%= device.is_online ? 'â— ì˜¨ë¼ì¸' : 'â—‹ ì˜¤í”„ë¼ì¸' %>
              </span>
            </div>

            <div class="device-info">
              <div class="info-row">
                <span class="info-label">ë¶„ìœ í†µ ë¬´ê²Œ</span>
                <span class="info-value">
                  <% if (device.bottle_weight && device.bottle_weight > 0) { %>
                    <%= device.bottle_weight %>g
                  <% } else { %>
                    <span style="color: var(--color-error); font-weight: var(--font-weight-semibold);">ë¯¸ë“±ë¡ âš ï¸</span>
                  <% } %>
                </span>
              </div>
              <div class="info-row">
                <span class="info-label">ë§ˆì§€ë§‰ ì—°ê²°</span>
                <span class="info-value" data-last-connected>
                  <%= device.last_connected ? new Date(device.last_connected).toLocaleString('ko-KR') : 'ì—°ê²° ì•ˆ ë¨' %>
                </span>
              </div>
              <div class="info-row">
                <span class="info-label">ë“±ë¡ì¼</span>
                <span class="info-value"><%= new Date(device.created_at).toLocaleDateString('ko-KR') %></span>
              </div>
            </div>

            <% if (!device.bottle_weight || device.bottle_weight === 0) { %>
              <div style="background: var(--color-error-lighter); border-left: 4px solid var(--color-error); padding: var(--spacing-3); border-radius: var(--radius-md); margin-bottom: var(--spacing-3); font-size: var(--font-size-sm);">
                âš ï¸ ìˆ˜ìœ  ê¸°ë¡ì„ ì‹œì‘í•˜ë ¤ë©´ ë¶„ìœ í†µ ë¬´ê²Œë¥¼ ë“±ë¡í•˜ì„¸ìš”!
              </div>
            <% } %>

            <div class="device-actions">
              <button class="btn-dashboard" onclick="location.href='/devices/<%= device.device_id %>/dashboard'" style="background: var(--color-primary); color: var(--color-white); flex: 1; padding: var(--spacing-2) var(--spacing-4); border-radius: var(--radius-md); border: none; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); cursor: pointer; transition: all var(--transition-base);">
                ğŸ“Š ëŒ€ì‹œë³´ë“œ
              </button>
              <button class="btn-edit" onclick="location.href='/devices/<%= device.device_id %>/edit'">
                <% if (!device.bottle_weight || device.bottle_weight === 0) { %>
                  âš–ï¸ ë¶„ìœ í†µ ë¬´ê²Œ ë“±ë¡
                <% } else { %>
                  âœï¸ ìˆ˜ì •
                <% } %>
              </button>
              <button class="btn-delete" onclick="deleteDevice(<%= device.device_id %>, '<%= device.device_name %>')">
                ğŸ—‘ï¸ ì‚­ì œ
              </button>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-icon">ğŸ“±</div>
        <h2 class="empty-title">ë“±ë¡ëœ ê¸°ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</h2>
        <p class="empty-desc">ìŠ¤ë§ˆíŠ¸ ì –ë³‘ ê¸°ê¸°ë¥¼ ë“±ë¡í•˜ì—¬ ìˆ˜ìœ  ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ê¸°ë¡í•˜ì„¸ìš”.</p>
        <a href="/devices/register" class="btn-primary">ì²« ê¸°ê¸° ë“±ë¡í•˜ê¸°</a>
      </div>
    <% } %>
  </div>

  <script>
    let pollingInterval = null;
    const POLLING_INTERVAL = 5000; // 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸

    /**
     * ê¸°ê¸° ì‚­ì œ
     */
    async function deleteDevice(deviceId, deviceName) {
      if (!confirm(`'${deviceName}' ê¸°ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì—°ê´€ëœ ìˆ˜ìœ  ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
        return;
      }

      try {
        const response = await fetch(`/devices/api/${deviceId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();

        if (result.success) {
          alert('ê¸°ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          location.reload();
        } else {
          alert(`ì‚­ì œ ì‹¤íŒ¨: ${result.error}`);
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('ê¸°ê¸° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    /**
     * ì‹¤ì‹œê°„ ê¸°ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
     */
    async function updateDeviceStatus() {
      const indicator = document.getElementById('updateIndicator');

      try {
        // ì¸ë””ì¼€ì´í„° í‘œì‹œ
        indicator.classList.add('active');

        // ê¸°ê¸° ëª©ë¡ API í˜¸ì¶œ
        const response = await fetch('/devices/api/list');
        const result = await response.json();

        if (result.success && result.data) {
          const devices = result.data;

          // í˜„ì¬ í‘œì‹œëœ ê¸°ê¸° ìˆ˜ì™€ ë‹¤ë¥´ë©´ ì „ì²´ ìƒˆë¡œê³ ì¹¨
          const currentDeviceCount = document.querySelectorAll('.device-card').length;
          if (devices.length !== currentDeviceCount) {
            console.log('ìƒˆë¡œìš´ ê¸°ê¸°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
            location.reload();
            return;
          }

          // ê° ê¸°ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
          devices.forEach(device => {
            updateDeviceCard(device);
          });
        }

        // 3ì´ˆ í›„ ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€
        setTimeout(() => {
          indicator.classList.remove('active');
        }, 3000);

      } catch (error) {
        console.error('Update error:', error);
        indicator.classList.remove('active');
      }
    }

    /**
     * ê°œë³„ ê¸°ê¸° ì¹´ë“œ ì—…ë°ì´íŠ¸
     */
    function updateDeviceCard(device) {
      const card = document.querySelector(`[data-device-id="${device.device_id}"]`);
      if (!card) return;

      // ìƒíƒœ ë±ƒì§€ ì—…ë°ì´íŠ¸
      const statusBadge = card.querySelector('.status-badge');
      const currentStatus = statusBadge.getAttribute('data-status');
      const newStatus = device.is_online ? 'online' : 'offline';

      if (currentStatus !== newStatus) {
        // ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ
        statusBadge.setAttribute('data-status', newStatus);
        statusBadge.className = `status-badge ${newStatus === 'online' ? 'status-online' : 'status-offline'} status-changed`;
        statusBadge.textContent = newStatus === 'online' ? 'â— ì˜¨ë¼ì¸' : 'â—‹ ì˜¤í”„ë¼ì¸';

        // ì• ë‹ˆë©”ì´ì…˜ ì œê±° (ë‹¤ìŒ ë³€ê²½ì„ ìœ„í•´)
        setTimeout(() => {
          statusBadge.classList.remove('status-changed');
        }, 500);

        // ìƒíƒœ ë³€ê²½ ì•Œë¦¼ (ì„ íƒì )
        console.log(`${device.device_name} ìƒíƒœ ë³€ê²½: ${currentStatus} â†’ ${newStatus}`);
      }

      // ë§ˆì§€ë§‰ ì—°ê²° ì‹œê°„ ì—…ë°ì´íŠ¸
      const lastConnectedElement = card.querySelector('[data-last-connected]');
      if (lastConnectedElement && device.last_connected) {
        const formattedDate = new Date(device.last_connected).toLocaleString('ko-KR');
        lastConnectedElement.textContent = formattedDate;
      }
    }

    /**
     * í´ë§ ì‹œì‘
     */
    function startPolling() {
      // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
      updateDeviceStatus();

      // 5ì´ˆë§ˆë‹¤ ë°˜ë³µ
      pollingInterval = setInterval(updateDeviceStatus, POLLING_INTERVAL);

      console.log('ì‹¤ì‹œê°„ ê¸°ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œì‘ (5ì´ˆ ê°„ê²©)');
    }

    /**
     * í´ë§ ì¤‘ì§€
     */
    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('ì‹¤ì‹œê°„ ê¸°ê¸° ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ì§€');
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í´ë§ ì‹œì‘
    document.addEventListener('DOMContentLoaded', () => {
      <% if (devices && devices.length > 0) { %>
        startPolling();
      <% } %>
    });

    // í˜ì´ì§€ë¥¼ ë²—ì–´ë‚  ë•Œ í´ë§ ì¤‘ì§€
    window.addEventListener('beforeunload', () => {
      stopPolling();
    });

    // í˜ì´ì§€ê°€ ë³´ì´ì§€ ì•Šì„ ë•Œ í´ë§ ì¤‘ì§€ (íƒ­ ì „í™˜ ë“±)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopPolling();
      } else {
        <% if (devices && devices.length > 0) { %>
          startPolling();
        <% } %>
      }
    });
  </script>
</body>
</html>
