<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Smart Bottle</title>
  <link rel="stylesheet" href="/assets/css/dashboard.css">
  <style>
    .edit-container { max-width: 600px; margin: 0 auto; padding: var(--spacing-8); }
    .page-title { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary); margin-bottom: var(--spacing-2); }
    .page-subtitle { font-size: var(--font-size-base); color: var(--color-text-secondary); margin-bottom: var(--spacing-8); }
    .form-card { background: var(--color-white); border-radius: var(--radius-2xl); padding: var(--spacing-8); box-shadow: var(--shadow-sm); }
    .form-group { margin-bottom: var(--spacing-6); }
    .form-label { display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-primary); margin-bottom: var(--spacing-2); }
    .form-input { width: 100%; padding: var(--spacing-3) var(--spacing-4); border: 2px solid var(--color-gray-200); border-radius: var(--radius-md); font-size: var(--font-size-base); transition: all var(--transition-base); }
    .form-input:focus { outline: none; border-color: var(--color-primary); }
    .form-help { font-size: var(--font-size-sm); color: var(--color-text-tertiary); margin-top: var(--spacing-2); }
    .form-help-important { color: var(--color-primary); font-weight: var(--font-weight-medium); }
    .info-box { background: var(--color-primary-lighter); border-left: 4px solid var(--color-primary); padding: var(--spacing-4); border-radius: var(--radius-md); margin-bottom: var(--spacing-6); }
    .info-title { font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); color: var(--color-primary); margin-bottom: var(--spacing-2); }
    .info-steps { font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: 1.6; }
    .info-steps li { margin-bottom: var(--spacing-1); }
    .form-actions { display: flex; gap: var(--spacing-3); margin-top: var(--spacing-8); }
    .btn { flex: 1; padding: var(--spacing-3) var(--spacing-6); border-radius: var(--radius-md); border: none; font-size: var(--font-size-base); font-weight: var(--font-weight-medium); cursor: pointer; transition: all var(--transition-base); }
    .btn-primary { background: var(--color-primary); color: var(--color-white); }
    .btn-primary:hover { background: var(--color-primary-dark); }
    .btn-secondary { background: var(--color-gray-100); color: var(--color-text-secondary); }
    .btn-secondary:hover { background: var(--color-gray-200); }
    .btn-measure { background: var(--color-primary-light); color: var(--color-white); width: 100%; margin-bottom: var(--spacing-3); }
    .btn-measure:hover { background: var(--color-primary); }

    /* ì¸¡ì • ëª¨ë‹¬ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--color-white); border-radius: var(--radius-2xl); padding: var(--spacing-8); max-width: 500px; width: 90%; box-shadow: var(--shadow-xl); }
    .modal-title { font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin-bottom: var(--spacing-4); text-align: center; }
    .modal-status { font-size: var(--font-size-lg); color: var(--color-text-secondary); margin-bottom: var(--spacing-6); text-align: center; line-height: 1.6; }
    .weight-display { background: var(--color-primary-lighter); border-radius: var(--radius-lg); padding: var(--spacing-6); margin-bottom: var(--spacing-6); text-align: center; }
    .weight-value { font-size: var(--font-size-4xl); font-weight: var(--font-weight-bold); color: var(--color-primary); }
    .weight-unit { font-size: var(--font-size-lg); color: var(--color-text-secondary); margin-left: var(--spacing-2); }
    .loading-spinner { width: 60px; height: 60px; border: 4px solid var(--color-gray-200); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: var(--spacing-6) auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress-dots { text-align: center; font-size: var(--font-size-2xl); color: var(--color-primary); margin: var(--spacing-4) 0; }
    .modal-actions { display: flex; gap: var(--spacing-3); margin-top: var(--spacing-6); }
  </style>
</head>
<body>
  <div class="edit-container">
    <h1 class="page-title">
      <% if (!device.bottle_weight || device.bottle_weight === 0) { %>
        âš–ï¸ ë¶„ìœ í†µ ë¬´ê²Œ ë“±ë¡
      <% } else { %>
        âœï¸ ê¸°ê¸° ì •ë³´ ìˆ˜ì •
      <% } %>
    </h1>
    <p class="page-subtitle">ê¸°ê¸° ì´ë¦„ê³¼ ë¶„ìœ í†µ ë¬´ê²Œë¥¼ ì„¤ì •í•˜ì„¸ìš”</p>

    <div class="form-card">
      <form id="editForm">
        <div class="form-group">
          <label class="form-label" for="device_uuid">ê¸°ê¸° UUID (ë³€ê²½ ë¶ˆê°€)</label>
          <input
            type="text"
            id="device_uuid"
            class="form-input"
            value="<%= device.device_uuid %>"
            disabled
          >
          <p class="form-help">ê¸°ê¸°ì˜ ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤. ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="device_name">ê¸°ê¸° ì´ë¦„ *</label>
          <input
            type="text"
            id="device_name"
            name="device_name"
            class="form-input"
            value="<%= device.device_name %>"
            placeholder="ì˜ˆ: ê±°ì‹¤ ìŠ¤ë§ˆíŠ¸ ì –ë³‘"
            required
          >
          <p class="form-help">ê¸°ê¸°ë¥¼ ì‰½ê²Œ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
        </div>

        <div class="info-box">
          <h3 class="info-title">âš ï¸ ë¶„ìœ í†µ ë¬´ê²Œ ì„¤ì •ì´ ì¤‘ìš”í•œ ì´ìœ </h3>
          <ol class="info-steps">
            <li>ë¶„ìœ í†µì„ ì˜¬ë¦¬ë©´ ì¸¡ì •ë˜ëŠ” ë¬´ê²Œ = <strong>ë¶„ìœ  ë¬´ê²Œ + ë¶„ìœ í†µ ë¬´ê²Œ</strong></li>
            <li>ì‹¤ì œ ë¨¹ì€ ì–‘ ê³„ì‚° ì‹œ ë¶„ìœ í†µ ë¬´ê²Œê°€ ìë™ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤</li>
            <li>ì •í™•í•œ ì¸¡ì •ì„ ìœ„í•´ <strong>ë¹ˆ ë¶„ìœ í†µì˜ ë¬´ê²Œ</strong>ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”</li>
          </ol>
        </div>

        <div class="form-group">
          <label class="form-label" for="bottle_weight">ë¶„ìœ í†µ ë¬´ê²Œ (g) *</label>
          <button type="button" class="btn btn-measure" onclick="startWeightMeasurement()">
            âš–ï¸ ë¶„ìœ í†µ ë¬´ê²Œ ì¸¡ì •
          </button>
          <input
            type="number"
            id="bottle_weight"
            name="bottle_weight"
            class="form-input"
            value="<%= device.bottle_weight %>"
            placeholder="ì˜ˆ: 85.5"
            step="0.1"
            min="0"
            required
          >
          <p class="form-help form-help-important">
            ğŸ’¡ ìë™ ì¸¡ì •: ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìë™ìœ¼ë¡œ ë¬´ê²Œë¥¼ ì¸¡ì •í•˜ê±°ë‚˜, ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.
          </p>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="history.back()">
            ì·¨ì†Œ
          </button>
          <button type="submit" class="btn btn-primary">
            <% if (!device.bottle_weight || device.bottle_weight === 0) { %>
              âœ… ë“±ë¡ ì™„ë£Œ
            <% } else { %>
              âœ… ì €ì¥
            <% } %>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ë¬´ê²Œ ì¸¡ì • ëª¨ë‹¬ -->
  <div id="measureModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">âš–ï¸ ë¶„ìœ í†µ ë¬´ê²Œ ì¸¡ì •</h2>
      <div id="modalBody">
        <!-- ë™ì ìœ¼ë¡œ ë³€ê²½ë¨ -->
      </div>
    </div>
  </div>

  <script>
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const deviceId = <%= device.device_id %>;
      const deviceName = document.getElementById('device_name').value;
      const bottleWeight = parseFloat(document.getElementById('bottle_weight').value);

      if (!deviceName) {
        alert('ê¸°ê¸° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (isNaN(bottleWeight) || bottleWeight < 0) {
        alert('ë¶„ìœ í†µ ë¬´ê²Œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const response = await fetch(`/devices/api/${deviceId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            device_name: deviceName,
            bottle_weight: bottleWeight
          })
        });

        const result = await response.json();

        if (result.success) {
          const wasEmpty = <%= device.bottle_weight ? 'false' : 'true' %>;
          if (wasEmpty && bottleWeight > 0) {
            alert('ë¶„ìœ í†µ ë¬´ê²Œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ì œ ìˆ˜ìœ  ê¸°ë¡ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ‰');
          } else {
            alert('ê¸°ê¸° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }
          location.href = '/devices';
        } else {
          alert(`ìˆ˜ì • ì‹¤íŒ¨: ${result.error}`);
        }
      } catch (error) {
        console.error('Update error:', error);
        alert('ê¸°ê¸° ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // ë¬´ê²Œ ì¸¡ì • ê´€ë ¨ ë³€ìˆ˜
    let measureInterval = null;
    let weightHistory = [];
    const STABILITY_THRESHOLD = 0.5; // 0.5g ì´ë‚´ ë³€í™”
    const STABILITY_DURATION = 3; // 3ì´ˆê°„ ì•ˆì •

    /**
     * ë¬´ê²Œ ì¸¡ì • ì‹œì‘
     */
    async function startWeightMeasurement() {
      const modal = document.getElementById('measureModal');
      const modalBody = document.getElementById('modalBody');
      const deviceId = <%= device.device_id %>;

      // ëª¨ë‹¬ ì—´ê¸°
      modal.classList.add('active');

      // 1ë‹¨ê³„: ì˜ì  ì¡°ì •
      modalBody.innerHTML = `
        <div class="loading-spinner"></div>
        <p class="modal-status">ë¬´ê²Œ ì„¼ì„œ ì˜ì ì„ ì¡°ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        <div class="progress-dots">âš™ï¸</div>
      `;

      try {
        // ì˜ì  ì¡°ì • API í˜¸ì¶œ
        const tareResponse = await fetch(`/devices/api/${deviceId}/tare`, {
          method: 'POST'
        });
        const tareResult = await tareResponse.json();

        if (!tareResult.success) {
          throw new Error('ì˜ì  ì¡°ì • ì‹¤íŒ¨');
        }

        // 2ë‹¨ê³„: ì –ë³‘ ì˜¬ë¦¬ê¸° ì•ˆë‚´
        await new Promise(resolve => setTimeout(resolve, 1500));
        modalBody.innerHTML = `
          <p class="modal-status">
            ì˜ì  ì¡°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!<br><br>
            <strong>ë¹ˆ ë¶„ìœ í†µì„ ë¬´ê²Œ ì„¼ì„œì— ì˜¬ë ¤ì£¼ì„¸ìš”.</strong>
          </p>
          <div class="progress-dots">ğŸ“‹ â³</div>
        `;

        // 3ë‹¨ê³„: ë¬´ê²Œ ì¸¡ì • ì‹œì‘
        await new Promise(resolve => setTimeout(resolve, 2000));
        startWeightPolling(deviceId);

      } catch (error) {
        console.error('Measurement error:', error);
        modalBody.innerHTML = `
          <p class="modal-status" style="color: var(--color-error);">
            âŒ ì¸¡ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
            ${error.message}
          </p>
          <div class="modal-actions">
            <button class="btn btn-primary" onclick="closeModal()">í™•ì¸</button>
          </div>
        `;
      }
    }

    /**
     * ë¬´ê²Œ í´ë§ ì‹œì‘
     */
    function startWeightPolling(deviceId) {
      const modalBody = document.getElementById('modalBody');
      weightHistory = [];

      modalBody.innerHTML = `
        <p class="modal-status">ë¬´ê²Œë¥¼ ì¸¡ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        <div class="weight-display">
          <span class="weight-value" id="currentWeight">0.0</span>
          <span class="weight-unit">g</span>
        </div>
        <p class="modal-status" style="font-size: var(--font-size-sm); color: var(--color-text-tertiary);">
          ë¬´ê²Œê°€ ì•ˆì •í™”ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...
        </p>
      `;

      // 1ì´ˆë§ˆë‹¤ ë¬´ê²Œ ì¡°íšŒ
      measureInterval = setInterval(async () => {
        try {
          const response = await fetch(`/devices/api/${deviceId}/weight`);
          const result = await response.json();

          if (result.success) {
            const weight = result.data.weight;
            document.getElementById('currentWeight').textContent = weight.toFixed(1);

            // ë¬´ê²Œ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            weightHistory.push(weight);

            // ì•ˆì •í™” í™•ì¸ (ìµœê·¼ 3ê°œ ë°ì´í„°)
            if (weightHistory.length >= STABILITY_DURATION) {
              const recentWeights = weightHistory.slice(-STABILITY_DURATION);
              const maxWeight = Math.max(...recentWeights);
              const minWeight = Math.min(...recentWeights);
              const difference = maxWeight - minWeight;

              // ë¬´ê²Œê°€ ì•ˆì •í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
              if (difference <= STABILITY_THRESHOLD && weight > 10) {
                clearInterval(measureInterval);
                onWeightStabilized(weight);
              }
            }

            // íˆìŠ¤í† ë¦¬ í¬ê¸° ì œí•œ (ìµœê·¼ 10ê°œë§Œ ìœ ì§€)
            if (weightHistory.length > 10) {
              weightHistory.shift();
            }
          }
        } catch (error) {
          console.error('Weight polling error:', error);
          clearInterval(measureInterval);
          modalBody.innerHTML = `
            <p class="modal-status" style="color: var(--color-error);">
              âŒ ë¬´ê²Œ ì¸¡ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            </p>
            <div class="modal-actions">
              <button class="btn btn-primary" onclick="closeModal()">í™•ì¸</button>
            </div>
          `;
        }
      }, 1000);
    }

    /**
     * ë¬´ê²Œ ì•ˆì •í™” ì™„ë£Œ
     */
    async function onWeightStabilized(weight) {
      const modalBody = document.getElementById('modalBody');
      const deviceId = <%= device.device_id %>;

      modalBody.innerHTML = `
        <p class="modal-status" style="color: var(--color-success); font-weight: var(--font-weight-semibold);">
          âœ… ì¸¡ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
        </p>
        <div class="weight-display">
          <span class="weight-value">${weight.toFixed(1)}</span>
          <span class="weight-unit">g</span>
        </div>
        <p class="modal-status">
          ë¶„ìœ í†µì˜ ë¬´ê²ŒëŠ” <strong>${weight.toFixed(1)}g</strong>ì…ë‹ˆë‹¤.<br>
          ìë™ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤...
        </p>
      `;

      // ìë™ ì €ì¥
      try {
        await new Promise(resolve => setTimeout(resolve, 1500));

        const deviceName = document.getElementById('device_name').value;
        const response = await fetch(`/devices/api/${deviceId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            device_name: deviceName,
            bottle_weight: weight
          })
        });

        const result = await response.json();

        if (result.success) {
          // ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
          document.getElementById('bottle_weight').value = weight.toFixed(1);

          // ì¸¡ì • ëª¨ë“œ ì¢…ë£Œ ì´ë²¤íŠ¸ ì „ì†¡ (í•˜ë“œì›¨ì–´ì— ì•Œë¦¼)
          try {
            await fetch(`/devices/api/${deviceId}/measure-stop`, {
              method: 'POST'
            });
            console.log('âœ… ì¸¡ì • ëª¨ë“œ ì¢…ë£Œ ì´ë²¤íŠ¸ ì „ì†¡ ì™„ë£Œ');
          } catch (stopError) {
            console.error('âš ï¸ ì¸¡ì • ì¢…ë£Œ ì´ë²¤íŠ¸ ì „ì†¡ ì‹¤íŒ¨ (ë¬´ì‹œ ê°€ëŠ¥):', stopError);
          }

          modalBody.innerHTML = `
            <p class="modal-status" style="color: var(--color-success); font-weight: var(--font-weight-semibold);">
              âœ… ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            </p>
            <div class="weight-display">
              <span class="weight-value">${weight.toFixed(1)}</span>
              <span class="weight-unit">g</span>
            </div>
            <p class="modal-status">
              ë¶„ìœ í†µ ë¬´ê²Œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.
            </p>
            <div class="modal-actions">
              <button class="btn btn-primary" onclick="closeModal()">í™•ì¸</button>
            </div>
          `;
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        console.error('Save error:', error);
        modalBody.innerHTML = `
          <p class="modal-status" style="color: var(--color-error);">
            âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
            ${error.message}
          </p>
          <div class="modal-actions">
            <button class="btn btn-primary" onclick="closeModal()">í™•ì¸</button>
          </div>
        `;
      }
    }

    /**
     * ëª¨ë‹¬ ë‹«ê¸°
     */
    function closeModal() {
      const modal = document.getElementById('measureModal');
      modal.classList.remove('active');

      if (measureInterval) {
        clearInterval(measureInterval);
        measureInterval = null;
      }
      weightHistory = [];
    }

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('measureModal').addEventListener('click', (e) => {
      if (e.target.id === 'measureModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>
